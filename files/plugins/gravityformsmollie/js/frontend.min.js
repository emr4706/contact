window.GFMollie=null,function(o){GFMollie=function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);var n=this;this.mollie=null,this.form=null,this.ccfields=null,this.activeFeed=null,this.feedActivated=!1,this.cardHasError={},this.cardHolder=this.cardNumber=this.cardNumberInput=this.expiryDate=this.verificationCode=null,this.init=function(){this.form=o("#gform_"+this.formId),this.ccfields="#field_"+this.formId+"_"+this.ccFieldId,this.cardNumberInput="#input_"+this.formId+"_"+this.ccFieldId+"_1",this.bindFormSubmit(),this.isPaymentFieldOnPage()&&(this.bindSetPaymentMethod(),this.bindFrontendFeedsEvaluated())},this.bindFormSubmit=function(){this.form.on("submit",function(e){n.clearError(),n.feedActivated&&n.isCreditCardMethodSelected(n.formId)&&"1"!==o("#gform_save_"+n.formId).val()&&!o(this).data("gfmolliesubmitting")&&n.isPaymentFieldOnPage()&&(n.isGoPrevPage(n.formId)?n.clearCardToken(n.formId):n.getCardToken(n.formId)&&!n.isPaymentFieldOnPage()||(e.preventDefault(),o(n.form).data("gfmolliesubmitting")||o(n.form).data("gfmolliesubmitting",!0),n.handleFormSubmit()))})},this.bindFrontendFeedsEvaluated=function(){gform.addAction("gform_frontend_feeds_evaluated",function(e,t){if(t===n.formId){n.feedActivated=!1;for(var i=0;i<Object.keys(e).length;i++)if("gravityformsmollie"===e[i].addonSlug&&e[i].isActivated){n.feedActivated=!0;for(var r=0;r<Object.keys(n.feeds).length;r++)if(n.feeds[r].feedId===e[i].feedId){n.activeFeed=n.feeds[r];break}break}n.feedActivated?(n.maybeShowMollieField(n.formId),n.maybeShowCcFields(n.formId)):(n.activeFeed=null,n.unmountMollieComponents(),o(".gfield_mollie").hide())}})},this.bindSetPaymentMethod=function(){""!==this.profileId&&(this.mollie=Mollie(this.profileId,{locale:gform_mollie_components_strings.locale,testmode:this.testMode,loglevel:1})),o(".ginput_mollie_payment_method select").on("change",function(){n.clearError(),n.maybeShowCcFields(n.formId)})},this.createMollieComponents=function(){if(""!==this.profileId&&null===this.cardNumber){var e={styles:n.cardStyle};this.cardHolder=n.mollie.createComponent("cardHolder",e),this.cardNumber=n.mollie.createComponent("cardNumber",e),this.expiryDate=n.mollie.createComponent("expiryDate",e),this.verificationCode=n.mollie.createComponent("verificationCode",e)}},this.mountMollieComponents=function(){""===this.profileId||o(this.cardNumberInput).find(".mollie-component").length||(this.cardHolder.mount("#input_"+this.formId+"_"+this.ccFieldId+"_5"),this.cardNumber.mount(this.cardNumberInput),this.expiryDate.mount("#input_"+this.formId+"_"+this.ccFieldId+"_2"),this.verificationCode.mount("#input_"+this.formId+"_"+this.ccFieldId+"_3"),this.cardNumber.addEventListener("focus",function(e){wp.a11y.speak(o("#field_"+n.formId+"_"+n.ccFieldId+"_supported_creditcards").text()),n.clearError()}),this.cardNumber.addEventListener("change",this.handleComponentError),this.cardHolder.addEventListener("change",this.handleComponentError),this.expiryDate.addEventListener("change",this.handleComponentError),this.verificationCode.addEventListener("change",this.handleComponentError))},this.unmountMollieComponents=function(){o(this.cardNumberInput).find(".mollie-component").length&&(this.cardNumber.unmount(),this.cardHolder.unmount(),this.expiryDate.unmount(),this.verificationCode.unmount(),this.hideCcFields(n.formId))},this.handleComponentError=function(e){if(e.error&&e.touched){var t={type:this.type,message:e.error};n.showError(t)}else if(n.clearError(),delete n.cardHasError[this.type],Object.keys(n.cardHasError).length)for(var i=["cardNumber","expiryDate","verificationCode","cardHolder"],r=0;r<i.length;r++){var o=i[r];if(n.cardHasError.hasOwnProperty(o))return n.showError({type:o,message:n.cardHasError[o]}),!1}},this.handleFormSubmit=function(){gformAddSpinner(n.formId),n.mollie.createToken().then(function(e){if(e.error)return e.error.message&&n.showError(e.error),void n.resetMollieStatus();n.addTokenInputToForm(e.token,n.formId),n.form.submit()})},this.paymentMethodSelected=function(e){var t=this.form.find(".ginput_mollie_payment_method select").val();if(null===t){var i=this.form.find(".ginput_mollie_payment_method select option[selected]");i.length&&(this.form.find(".ginput_mollie_payment_method select").val(i.val()),t=i.val())}return t},this.isCreditCardMethodSelected=function(e){return"creditcard"===this.paymentMethodSelected(e)},this.maybeShowMollieField=function(e){1===this.form.find(".ginput_mollie_payment_method select option").length?this.isCreditCardMethodSelected(e)?this.form.find(".ginput_mollie_payment_method").hide():this.form.find(".gfield_mollie").hide():this.form.find(".gfield_mollie").show()},this.maybeShowCcFields=function(e){this.isCreditCardMethodSelected(e)?(this.showCcFields(),this.createMollieComponents(),this.mountMollieComponents()):this.hideCcFields()},this.isGoPrevPage=function(e){var t=parseInt(o("#gform_source_page_number_"+e).val(),10),i=parseInt(o("#gform_target_page_number_"+e).val(),10);return i<t&&0!==i},this.showCcFields=function(){this.form.find(".ginput_container_mollie_components").removeClass("gf_invisible")},this.hideCcFields=function(){this.form.find(".ginput_container_mollie_components").addClass("gf_invisible")},this.showError=function(e){0<o("#gform_ajax_spinner_"+this.formId).length&&o("#gform_ajax_spinner_"+this.formId).remove(),o(this.ccfields).addClass("gfield_error"),o(this.ccfields).find(".validation_message").length||o(this.ccfields).append('<div class="gfield_description validation_message"></div>');var t=o(this.ccfields).find(".validation_message"),i=gform_mollie_components_strings.errorprefix;e.message&&(i=i+": "+e.message),n.cardHasError[e.type]=e.message?e.message:"",t.text(i),wp.a11y.speak(i)},this.clearError=function(){o(this.ccfields).removeClass("gfield_error").find(".validation_message").remove()},this.addTokenInputToForm=function(e,t){if(0===o("#gform_"+t+" input[name=cardToken]").length){var i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("name","cardToken"),this.form.append(i)}this.setCardToken(e,t)},this.setCardToken=function(e,t){o("#gform_"+t+" input[name=cardToken]").val(e)},this.getCardToken=function(e){var t=o("#gform_"+e+" input[name=cardToken]");return 1===t.length&&""!==t.val()&&t.val()},this.clearCardToken=function(e){o("#gform_"+e+" input[name=cardToken]").val("")},this.isPaymentFieldOnPage=function(){var e=this.getCurrentPageNumber();return!!o("#input_"+this.formId+"_"+this.ccFieldId+"_1").length&&(!this.pmfieldPage||!e||this.pmfieldPage==e)},this.getCurrentPageNumber=function(){var e=o("#gform_source_page_number_"+this.formId);return 0<e.length&&e.val()},this.isLastPage=function(){var e=o("#gform_target_page_number_"+this.formId);return!(0<e.length)||"0"===e.val()},this.resetMollieStatus=function(){o(this.form).data("gfmolliesubmitting",!1),o("#gform_ajax_spinner_"+this.formId).remove(),this.isLastPage()&&(window["gf_submitting_"+this.formId]=!1),this.clearCardToken(this.formId)},this.init()}}(jQuery);